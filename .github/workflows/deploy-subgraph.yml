name: Deploy Subgraph

on:
  workflow_dispatch:
    inputs:
      action:
        description: '选择要执行的操作'
        required: true
        type: choice
        options:
          - clone-code
          - deploy-subgraph
      branch:
        description: 'Branch to clone'
        required: false
        default: 'main'
      repository:
        description: 'Repository URL (optional, defaults to current repo)'
        required: false
        default: ''

jobs:
  clone-code:
    name: Clone Code on Self-Hosted
    runs-on: self-hosted
    if: github.event.inputs.action == 'clone-code'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
          fetch-depth: 0  # 获取完整的 git 历史
      
      - name: Display repository info
        run: |
          echo "Repository: $(git config --get remote.origin.url)"
          echo "Branch: $(git branch --show-current)"
          echo "Commit: $(git rev-parse HEAD)"
          echo "Working directory: $(pwd)"
          ls -la
      
      - name: Verify code cloned
        run: |
          if [ -f "package.json" ]; then
            echo "✓ Code successfully cloned"
            echo "Repository contents verified"
          else
            echo "✗ Failed to clone code"
            exit 1
          fi

  deploy-subgraph:
    name: Deploy Subgraph
    runs-on: self-hosted
    if: github.event.inputs.action == 'deploy-subgraph'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
      
      - name: Clean and install dependencies
        run: |
          echo "清理旧的依赖和缓存..."
          rm -rf node_modules
          yarn cache clean
      
      - name: Deploy subgraph
        run: |
          echo "开始部署 subgraph..."
          echo "工作目录: $(pwd)"
          yarn && yarn build --network xlayer-mainnet --subgraph-type v2 --deploy
          echo "✓ Subgraph 部署完成"

